# Prompt Final — Modul Reference TMI (Filament v4 + SQL Server + Excel + PDF)

Gunakan prompt ini untuk membuat / memperbarui modul **Reference → TMI** pada aplikasi Laravel (Laravel 12, PHP 8.3) menggunakan **FilamentPHP v4 (WAJIB)** dan database **SQL Server (SSMS)**.

---

## A. Format Excel (UPLOAD)

File Excel yang akan di-upload mengikuti pola template:

- Path template: `/home/heden/acurex/storage/app/templates/format*upload_tmi_3*.xlsx`
- Format kolom:
  - Kolom pertama **wajib**: `trot`
  - Kolom berikutnya **dinamis** (header diambil apa adanya dari file user)

Contoh header:

`"trot | Laki-laki ( TMI 3 ) | Perempuan ( TMI 3 ) | Unisex | Reas - Pria | Reas - Unisex | Dipakai"`

Catatan data:

- Nilai `rate` bisa memakai **koma desimal** (contoh `0,00802`) sehingga harus dikonversi menjadi float (koma → titik).
- `trot` bersifat **dinamis** (contoh 0..111, tapi bisa lebih / kurang).

---

## B. Database (SQL Server / SSMS)

- Database: `acurex_sql_db`
- Schema: `reference`
- Jangan buat migration Laravel.
- Buat **SQL Script SSMS** untuk:
  1) create schema (jika belum ada)  
  2) create table:
     - `[reference].[tmis]`
     - `[reference].[tmi_columns]`
     - `[reference].[tmi_rates]`
  3) create index & filtered unique index (soft delete)  
  4) seed minimal:
     - insert header `TMI 3`
     - insert default kolom awal (6 kolom: Laki-laki, Perempuan, Unisex, Reas-Pria, Reas-Unisex, Dipakai)

Standar kolom table (**WAJIB** ada):

- `created_at datetime NOT NULL`
- `updated_at datetime NULL`
- `deleted_at datetime NULL`
- `created_by bigint NOT NULL`
- `keterangan varchar(255) NULL`

---

## C. Model (Eloquent)

Buat model berikut (SQL Server schema `reference.*` + SoftDeletes):

- `App\Models\Reference\Tmi` (table: `reference.tmis`)
- `App\Models\Reference\TmiColumn` (table: `reference.tmi_columns`)
- `App\Models\Reference\TmiRate` (table: `reference.tmi_rates`)

Relasi:

- `Tmi hasMany columns`
- `Tmi hasMany rates`
- `TmiRate belongsTo column`
- `TmiRate belongsTo tmi`
- `TmiColumn belongsTo tmi`

---

## D. Import / Export (Maatwebsite Excel)

WAJIB pakai Maatwebsite Excel.

### 1) Import (lokasi file WAJIB)

- `app/Imports/Reference/TmiRateImport.php`

Fungsi import:

- Baca header:
  - validate kolom pertama = `trot`
  - kolom setelahnya jadi daftar `labels` dinamis
- Dalam transaksi:
  - soft delete data lama: rates & columns (`deleted_at = now()`)
  - create ulang columns sesuai labels:
    - `column_label` sesuai header asli
    - `column_key` slug
    - `sort_order` incremental
  - insert rates per baris:
    - `trot` = integer
    - `rate`: numeric string bisa koma desimal → ubah ke titik → float

### 2) Export (lokasi file WAJIB)

- `app/Exports/Reference/TmiRateExport.php`

Fungsi export:

- headings:
  - `['trot', ...dynamic column_label orderBy sort_order]`
- data:
  - group rates by `trot`
  - susun row sesuai urutan kolom

---

## E. Download via Controller (JANGAN lewat Resource)

**Semua fungsi download tidak boleh dipanggil dari Resource.**  
Semua download harus via **Controller** + **Route**.

WAJIB route group di `routes/web.php`:

- prefix: `portal-admin/reference/tmi`
- name: `portal-admin.reference.tmi.`

Controller yang wajib ada:

1) `app/Http/Controllers/Reference/TmiTemplateController.php`
   - method `downloadTmi3()`
   - ambil file dari `storage_path('app/templates')` dengan glob `format*upload_tmi_3*.xlsx`
   - download sebagai `tmi_3.xlsx`

2) `app/Http/Controllers/Reference/TmiExportController.php`
   - method `exportExcel(Tmi $tmi)`
   - return `Excel::download(new TmiRateExport($tmi->id), "tmi_{slug(informasi_tmi)}.xlsx")`

3) `app/Http/Controllers/Reference/TmiPdfController.php`
   - method `downloadPdf(Tmi $tmi)`
   - load relasi (`columns`, `rates`, `rates.column`) berurutan
   - render blade view
   - stream download PDF (DomPDF)

---

## F. PDF (DomPDF + Blade)

Paket: `barryvdh/laravel-dompdf` (anggap sudah terinstall)

Blade wajib di:

- `resources/views/reference/tmi/tmi-pdf.blade.php`

Isi blade:

- Data master: `informasi_tmi`, `keterangan`, timestamp cetak
- Tabel detail:
  - kolom pertama `trot`
  - kolom sisanya dynamic dari `columns`
  - cell diambil dari rates grouped by trot

---

## G. Filament v4 (Admin / Portal Admin)

Buat Filament Resource di:

- `app/Filament/Admin/Resources/Reference/Tmis/`

**Resource harus bersih** (tidak ada logika download / import / export di Resource).

Tambahkan di Resource:

```php
use BackedEnum;
use UnitEnum;

protected static ?string $modelLabel = 'TMI';
protected static string|BackedEnum|null $navigationIcon = Heroicon::OutlinedTableCells;

// Folder / group di menu
protected static UnitEnum|string|null $navigationGroup = 'Reference';

protected static ?string $navigationLabel = 'TMI';
protected static ?string $navigationSlug = 'reference/tmi';
protected static ?string $recordTitleAttribute = 'informasi_tmi';

public static function getPluralLabel(): string { return 'TMI'; }
public static function getModelLabel(): string { return 'TMI'; }
```

### Struktur jawaban WAJIB dipisah per file (sesuai struktur ini)

- Resources/Tmi
  - Pages
    - Create
    - Edit
    - List
    - View
  - Schemas
    - Form
    - Infolist
  - Tables
    - Table
  - Resources

---

## H. UI Requirements

### 1) Table (List)

Tampilkan tombol:

- Show
- Edit
- Download Excel (link ke route controller export)
- Download PDF (link ke route controller pdf)

### 2) Page List (Header)

- tombol “Download Format Excel” → link ke route template controller (`portal-admin.reference.tmi.template.tmi_3`)

### 3) Page Create

- input: `informasi_tmi`, `keterangan`
- set `created_by = auth()->id() ?? 0`
- set `created_at = now()`, `updated_at = null`, `deleted_at = null`
- matikan “create another”

### 4) Page Edit (Header actions)

- tombol “Kembali Ke Table” + icon kembali
- tombol upload Import TMI (Excel)
  - FileUpload disk **local**
  - directory `imports/tmi`
  - FIX PATH WAJIB:
    - disk `local` root = `storage/app/private`
    - ambil absolute path via:
      ```php
      $absolutePath = Storage::disk('local')->path($relativePath);
      ```
- tombol Delete

### 5) Page View

- infolist:
  - Section 1: Data Master
  - Section 2: Data Detail memakai RepeatableEntry (columnSpanFull)
- header actions:
  - Download Excel (route controller)
  - Download PDF (route controller)
  - Kembali ke Table (icon back)

---

## I. Output yang diminta

1) Script SQL SSMS (create schema + tables + index + seed)  
2) Semua file PHP sesuai struktur di atas (dipisah jelas per file path)  
3) Route `web.php` group  
4) Semua controller (template, export, pdf)  
5) Import & Export class  
6) Blade PDF  

**Catatan penting:** Jangan berikan script Filament v3/v2/v1. Hanya Filament v4.
