Prompt Baseline Umum — Modul Reference Dinamis (Filament v4 + SQL Server + Excel + PDF)

Gunakan prompt ini sebagai template umum untuk membangun modul apa pun (nama modul bisa berbeda-beda), namun hasil generate kode tetap konsisten dengan baseline implementasi Anda:

- FilamentPHP v4 (WAJIB)
- SQL Server (SSMS), tanpa migration Laravel
- Import Excel & Export Excel pakai `maatwebsite/excel`
- Download PDF pakai `barryvdh/laravel-dompdf` + Blade
- Semua download via Controller, bukan dari Resource
- Disk upload local root: `storage/app/private` (FIX path memakai `Storage::disk()->path()`)

---

0. Parameter yang harus Anda isi (ganti sesuai modul)

> Isi nilai-nilai berikut saat memakai prompt ini.

- MODULE_NAME_SINGULAR: contoh `Tmi`, `Tarif`, `Benefit`, `Premi`
- MODULE_NAME_PLURAL: contoh `Tmis`, `Tarifs`, `Benefits`, `Premis`
- MENU_GROUP: contoh `Reference`
- NAV_SLUG: contoh `reference/tmi` (untuk menu)
- ROUTE_PREFIX: contoh `portal-admin/reference/tmi`
- ROUTE_NAME_PREFIX: contoh `portal-admin.reference.tmi.`

- DB_NAME: contoh `acurex_sql_db`
- DB_SCHEMA: contoh `reference`
- TABLE_HEADER: contoh `tmis`
- TABLE_DYNAMIC_COLUMNS: contoh `tmi_columns`
- TABLE_DYNAMIC_RATES: contoh `tmi_rates`

- TEMPLATE_DIR_ABSOLUTE: contoh `storage_path('app/templates')`
- TEMPLATE_GLOB: contoh `format*upload_tmi_3*.xlsx`
- TEMPLATE_DOWNLOAD_NAME: contoh `tmi_3.xlsx`

- UPLOAD*DISK: `local` *(root = storage/app/private)\_
- UPLOAD_DIR: contoh `imports/tmi`

- BLADE_PDF_VIEW: contoh `reference.tmi.tmi-pdf`
- BLADE_PDF_PATH: contoh `resources/views/reference/tmi/tmi-pdf.blade.php`

- HEADER_FIELD_LABEL: contoh `informasi_tmi` (field title / versi)
- HEADER_FIELD_DESC: contoh `keterangan`

- EXCEL_FIRST_COLUMN: default `trot` (boleh diganti jika modul lain butuh key berbeda)

> Jika modul Anda bukan `trot`, gunakan istilah umum: `key_column` (mis. `age`, `year`, `tier`, `kode`).

---

1. Konteks & Syarat Utama (WAJIB)

Saya ingin Anda membuat / memperbarui modul {MODULE_NAME_SINGULAR} dengan ketentuan:

1. FilamentPHP v4 (jangan buat script v3/v2/v1).
2. Database memakai SQL Server dan dikerjakan via SSMS script, tanpa migration.
3. Database: {DB_NAME}, schema: {DB_SCHEMA}.
4. Table wajib memiliki kolom standar:

- `created_at datetime NOT NULL`
- `updated_at datetime NULL`
- `deleted_at datetime NULL`
- `created_by bigint NOT NULL`
- `keterangan varchar(255) NULL`

5. Dynamic:

- key baris dinamis (contoh `trot` 0..111 atau apa pun).
- nama kolom (header excel) dinamis sesuai file upload user.

6. Download tidak boleh dipanggil dari Resource. Semua download wajib via Controller + Route.
7. Export Excel wajib pakai `Maatwebsite\Excel`.
8. PDF wajib pakai `barryvdh/laravel-dompdf` + Blade, output via `streamDownload`.

---

2. Format Excel (UPLOAD)

Excel minimal memiliki:

- Kolom pertama wajib: `{EXCEL_FIRST_COLUMN}`
- Kolom berikutnya: header dinamis (nama kolom sesuai file user, disimpan sebagai dynamic columns)

Catatan parsing:

- Nilai angka bisa memakai koma desimal → konversi ke float (`,` → `.`).
- Baris kosong di-skip.

---

3. Database Design (SQL Server) — Header + Dynamic Columns + Rates

Buat SSMS script untuk:

3.1 Schema

- Buat schema `{DB_SCHEMA}` jika belum ada.

  3.2 Table Header: `{DB_SCHEMA}.{TABLE_HEADER}`

- Menyimpan master/versi/identitas modul, contoh: `TMI 3`, `3-2025`, dsb.
- Wajib: kolom id + `{HEADER_FIELD_LABEL}` + `{HEADER_FIELD_DESC}` + kolom standar.

  3.3 Table Dynamic Columns: `{DB_SCHEMA}.{TABLE_DYNAMIC_COLUMNS}`

- Menyimpan daftar kolom dinamis dari header excel.
- Field minimal:
- `header_id` (FK ke header)
- `column_label` (NVARCHAR, persis header excel)
- `column_key` (NVARCHAR, slug aman)
- `sort_order` (INT)
- kolom standar
- Wajib ada filtered unique index:
- `(header_id, column_key) WHERE deleted_at IS NULL`

  3.4 Table Rates: `{DB_SCHEMA}.{TABLE_DYNAMIC_RATES}`

- Menyimpan nilai per baris dan per kolom dinamis.
- Field minimal:
- `header_id` (FK ke header)
- `{EXCEL_FIRST_COLUMN}` (INT atau VARCHAR sesuai kebutuhan modul)
- `dynamic_column_id` (FK ke dynamic columns)
- `rate` (DECIMAL(18,6) atau sesuai kebutuhan)
- kolom standar
- Wajib ada filtered unique index:
- `(header_id, {EXCEL_FIRST_COLUMN}, dynamic_column_id) WHERE deleted_at IS NULL`

  3.5 Seeder SSMS (minimal)

- Insert 1 master/header default (mis. `{MODULE_NAME_SINGULAR} 1`).
- Insert beberapa dynamic columns default (opsional).
- Rates diisi via Import Excel.

---

4. Eloquent Model (SQL Server schema)

Buat 3 model (contoh namespace `App\Models\{MENU_GROUP}` atau `App\Models\Reference`):

- `HeaderModel` → table `{DB_SCHEMA}.{TABLE_HEADER}` (SoftDeletes)
- `DynamicColumnModel` → table `{DB_SCHEMA}.{TABLE_DYNAMIC_COLUMNS}` (SoftDeletes)
- `RateModel` → table `{DB_SCHEMA}.{TABLE_DYNAMIC_RATES}` (SoftDeletes)

Relasi wajib:

- Header `hasMany` DynamicColumns
- Header `hasMany` Rates
- Rate `belongsTo` DynamicColumn
- Rate `belongsTo` Header
- DynamicColumn `belongsTo` Header

---

5. Import Excel (maatwebsite/excel) — File path WAJIB

Lokasi class import (WAJIB):

- `app/Imports/{MENU_GROUP}/{MODULE_NAME_SINGULAR}RateImport.php`  
  _(atau pola Anda: `app/Imports/Reference/...`)_

Perilaku import:

1. Validasi header:

- kolom pertama harus `{EXCEL_FIRST_COLUMN}` (case-insensitive)

2. Ambil `labels` = semua header setelah kolom pertama (dinamis)
3. Dalam `DB::transaction`:

- Soft-delete data lama:
  - Rates + DynamicColumns (`deleted_at = now()`)
- Create ulang DynamicColumns:
  - `column_label` = label asli
  - `column_key` = `Str::slug(label, '_')`
  - `sort_order` incremental
- Insert rates:
  - baca `{EXCEL_FIRST_COLUMN}`
  - untuk setiap dynamic column index → ambil cell rate → parsing numeric:
    - jika string: trim, hapus spasi, ganti `,` jadi `.`, cast float
  - insert RateModel dengan created_by user aktif

---

6. Export Excel (maatwebsite/excel) — File path WAJIB

Lokasi class export (WAJIB):

- `app/Exports/{MENU_GROUP}/{MODULE_NAME_SINGULAR}RateExport.php`  
  _(atau pola Anda: `app/Exports/Reference/...`)_

Perilaku export:

- `headings()`:
- `[{EXCEL_FIRST_COLUMN}, ...dynamic column_label orderBy sort_order]`
- `array()`:
- group rates by `{EXCEL_FIRST_COLUMN}`
- susun row sesuai urutan dynamic column id

---

7. PDF (DomPDF + Blade) — View path WAJIB

- Paket: `barryvdh/laravel-dompdf` (anggap terinstall)
- Blade:
- Path: `{BLADE_PDF_PATH}`
- View name: `{BLADE_PDF_VIEW}`

Isi PDF:

- Data master/header (label + keterangan + timestamp)
- Tabel detail:
- kolom pertama `{EXCEL_FIRST_COLUMN}`
- kolom sisanya dynamic column_label
- nilai diambil dari group rates

PDF Controller harus:

- load relasi detail (columns + rates + rates.column)
- render view blade
- `response()->streamDownload(fn() => print($pdf->output()), $fileName)`

---

8. Route & Controller (WAJIB)

8.1 Routes (web.php)
Buat route group:

- `prefix('{ROUTE_PREFIX}')`
- `name('{ROUTE_NAME_PREFIX}')`

Wajib endpoint:

1. Download Template:

- `GET /template/default`

2. Export Excel:

- `GET /{header}/export-excel`

3. Download PDF:

- `GET /{header}/download-pdf`

  8.2 Controllers (WAJIB)
  Letakkan di `app/Http/Controllers/{MENU_GROUP}/` (atau `Reference/`):

1. `{MODULE_NAME_SINGULAR}TemplateController`

- method `downloadTemplate()`
- cari template memakai:
  - `$dir = {TEMPLATE_DIR_ABSOLUTE};`
  - `glob($dir . '/{TEMPLATE_GLOB}')`
- download sebagai `{TEMPLATE_DOWNLOAD_NAME}`
- Catatan: Template bukan di disk `local` (karena local root = private). Pakai `storage_path('app/templates')` (absolute).

2. `{MODULE_NAME_SINGULAR}ExportController`

- method `exportExcel(HeaderModel $header)`
- `Excel::download(new RateExport($header->id), "module_{slug}.xlsx")`

3. `{MODULE_NAME_SINGULAR}PdfController`

- method `downloadPdf(HeaderModel $header)`
- load relasi detail dan render blade
- streamDownload

---

9. Filament v4 — Resource harus bersih

Buat Resource di:

- `app/Filament/Admin/Resources/{MENU_GROUP}/{MODULE_NAME_PLURAL}/`

Resource tidak boleh memuat logic download/import/export. Hanya UI + link route.

Tambahkan di Resource:

```php
use BackedEnum;
use UnitEnum;

protected static ?string $modelLabel = '{MODULE_NAME_SINGULAR}';
protected static string|BackedEnum|null $navigationIcon = Heroicon::OutlinedTableCells;
protected static UnitEnum|string|null $navigationGroup = '{MENU_GROUP}';
protected static ?string $navigationLabel = '{MODULE_NAME_SINGULAR}';
protected static ?string $navigationSlug = '{NAV_SLUG}';
protected static ?string $recordTitleAttribute = '{HEADER_FIELD_LABEL}';

public static function getPluralLabel(): string { return '{MODULE_NAME_SINGULAR}'; }
public static function getModelLabel(): string { return '{MODULE_NAME_SINGULAR}'; }
```

---

10. UI Requirements (WAJIB)

10.1 Table (List)
Record actions:

- Show (View)
- Edit
- Download Excel (URL route export)
- Download PDF (URL route pdf)

  10.2 List Page Header

- tombol “Download Format Excel” (URL route template)

  10.3 Create Page

- input `{HEADER_FIELD_LABEL}` dan `{HEADER_FIELD_DESC}`
- set:
- `created_by = auth()->id() ?? 0`
- `created_at = now()`
- `updated_at = null`
- `deleted_at = null`
- disable “create another”

  10.4 Edit Page Header

- tombol “Kembali Ke Table” (dengan icon kembali)
- tombol upload Import Excel:
- `FileUpload::disk('{UPLOAD_DISK}')`
- `->directory('{UPLOAD_DIR}')`
- FIX path:
  ```php
  $absolutePath = Storage::disk('{UPLOAD_DISK}')->path($relativePath);
  ```
- lalu `Excel::import(new RateImport($record, auth()->id() ?? 0), $absolutePath);`
- tombol Delete

  10.5 View Page

- Infolist:
- Section 1: Data Master (label + keterangan)
- Section 2: Data Detail menggunakan `RepeatableEntry` (columnSpanFull)
- Header actions:
- Download Excel
- Download PDF
- Kembali ke Table

---

11. Struktur Output (WAJIB dipisah per file)

Saat menjawab, pisahkan semua file sesuai struktur:

- Resources/{MODULE_NAME_SINGULAR}
- Pages
  - Create
  - Edit
  - List
  - View
- Schemas
  - Form
  - Infolist
- Tables
  - Table
- Resources

Tambahkan juga:

- Routes (`routes/web.php` snippet)
- Controllers
- Import class
- Export class
- Blade PDF
- SQL SSMS create+seed script

---

12. Catatan Konsistensi Baseline (PENTING)

- Jangan panggil function download di Resource.
- Import FileUpload wajib FIX path dari disk `local`:
- Disk `local` root = `storage/app/private`, jadi jangan pakai `storage_path('app/' . $relative)`.
- Pakai `Storage::disk('local')->path($relativePath)`.
- Template file berada di `storage/app/templates` (absolute), jadi gunakan `glob(storage_path('app/templates') . '/...')`.

---

13. Instruksi akhir untuk Anda (LLM)

Tolong hasilkan:

1. Script SQL SSMS lengkap (schema + tables + index + seed)
2. Semua file PHP/Blade sesuai struktur dan parameter di atas
3. Pastikan semua route name/prefix konsisten
4. Pastikan Filament v4 digunakan (API v4)
